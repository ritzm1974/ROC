{"ast":null,"code":"import { DialogType, MessageSeverity } from '../../services/alert.service';\nimport { Utilities } from '../../services/utilities';\nimport { User } from '../../models/user.model';\nimport { Role } from '../../models/role.model';\nimport { Permission } from '../../models/permission.model';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/alert.service\";\nimport * as i2 from \"../../services/app-translation.service\";\nimport * as i3 from \"../../services/account.service\";\nconst _c0 = [\"indexTemplate\"];\nconst _c1 = [\"userNameTemplate\"];\nconst _c2 = [\"rolesTemplate\"];\nconst _c3 = [\"actionsTemplate\"];\nconst _c4 = [\"editorModal\"];\nconst _c5 = [\"userEditor\"];\n\nfunction UsersManagementComponent_li_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r14 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"li\", 23)(1, \"a\", 24);\n    i0.ɵɵlistener(\"click\", function UsersManagementComponent_li_8_Template_a_click_1_listener() {\n      i0.ɵɵrestoreView(_r14);\n      const ctx_r13 = i0.ɵɵnextContext();\n      return ctx_r13.newUser();\n    });\n    i0.ɵɵelement(2, \"i\", 25);\n    i0.ɵɵtext(3);\n    i0.ɵɵpipe(4, \"translate\");\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(4, 1, \"users.management.NewUser\"), \" \");\n  }\n}\n\nfunction UsersManagementComponent_ng_template_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"strong\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const value_r15 = ctx.value;\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(value_r15);\n  }\n}\n\nfunction UsersManagementComponent_ng_template_12_i_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 28);\n  }\n}\n\nfunction UsersManagementComponent_ng_template_12_i_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 29);\n  }\n}\n\nfunction UsersManagementComponent_ng_template_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtemplate(1, UsersManagementComponent_ng_template_12_i_1_Template, 1, 0, \"i\", 26);\n    i0.ɵɵtemplate(2, UsersManagementComponent_ng_template_12_i_2_Template, 1, 0, \"i\", 27);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const row_r16 = ctx.row;\n    const value_r17 = ctx.value;\n    i0.ɵɵclassProp(\"locked-out\", row_r16.isLockedOut)(\"user-disabled\", !row_r16.isEnabled);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", row_r16.isLockedOut);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !row_r16.isEnabled);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", value_r17, \" \");\n  }\n}\n\nfunction UsersManagementComponent_ng_template_14_span_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 31);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const role_r24 = ctx.$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(role_r24);\n  }\n}\n\nfunction UsersManagementComponent_ng_template_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtemplate(0, UsersManagementComponent_ng_template_14_span_0_Template, 2, 1, \"span\", 30);\n  }\n\n  if (rf & 2) {\n    const value_r21 = ctx.value;\n    i0.ɵɵproperty(\"ngForOf\", value_r21);\n  }\n}\n\nfunction UsersManagementComponent_ng_template_16_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r31 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\")(1, \"a\", 33);\n    i0.ɵɵlistener(\"click\", function UsersManagementComponent_ng_template_16_div_0_Template_a_click_1_listener() {\n      i0.ɵɵrestoreView(_r31);\n      const row_r25 = i0.ɵɵnextContext().row;\n      const ctx_r29 = i0.ɵɵnextContext();\n      return ctx_r29.editUser(row_r25);\n    });\n    i0.ɵɵelement(2, \"i\", 34);\n    i0.ɵɵtext(3);\n    i0.ɵɵpipe(4, \"translate\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(5, \"| \");\n    i0.ɵɵelementStart(6, \"a\", 33);\n    i0.ɵɵlistener(\"click\", function UsersManagementComponent_ng_template_16_div_0_Template_a_click_6_listener() {\n      i0.ɵɵrestoreView(_r31);\n      const row_r25 = i0.ɵɵnextContext().row;\n      const ctx_r32 = i0.ɵɵnextContext();\n      return ctx_r32.deleteUser(row_r25);\n    });\n    i0.ɵɵelement(7, \"i\", 35);\n    i0.ɵɵtext(8);\n    i0.ɵɵpipe(9, \"translate\");\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(4, 2, \"users.management.Edit\"), \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(9, 4, \"users.management.Delete\"), \"\");\n  }\n}\n\nfunction UsersManagementComponent_ng_template_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtemplate(0, UsersManagementComponent_ng_template_16_div_0_Template, 10, 6, \"div\", 32);\n  }\n\n  if (rf & 2) {\n    const ctx_r8 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"ngIf\", ctx_r8.canManageUsers);\n  }\n}\n\nfunction UsersManagementComponent_h4_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"h4\", 36);\n    i0.ɵɵelement(1, \"i\", 37);\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"translate\");\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(3, 1, \"users.management.NewUser\"), \"\");\n  }\n}\n\nfunction UsersManagementComponent_h4_24_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"h4\", 36);\n    i0.ɵɵelement(1, \"i\", 38);\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"translate\");\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r11 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind2(3, 1, \"users.management.EditUser\", ctx_r11.editingUserName), \"\");\n  }\n}\n\nconst _c6 = function () {\n  return {\n    backdrop: \"static\"\n  };\n};\n\nexport let UsersManagementComponent = /*#__PURE__*/(() => {\n  class UsersManagementComponent {\n    constructor(alertService, translationService, accountService) {\n      this.alertService = alertService;\n      this.translationService = translationService;\n      this.accountService = accountService;\n      this.columns = [];\n      this.rows = [];\n      this.rowsCache = [];\n      this.allRoles = [];\n    }\n\n    ngOnInit() {\n      const gT = key => this.translationService.getTranslation(key);\n\n      this.columns = [{\n        prop: 'index',\n        name: '#',\n        width: 40,\n        cellTemplate: this.indexTemplate,\n        canAutoResize: false\n      }, {\n        prop: 'jobTitle',\n        name: gT('users.management.Title'),\n        width: 50\n      }, {\n        prop: 'userName',\n        name: gT('users.management.UserName'),\n        width: 90,\n        cellTemplate: this.userNameTemplate\n      }, {\n        prop: 'fullName',\n        name: gT('users.management.FullName'),\n        width: 120\n      }, {\n        prop: 'email',\n        name: gT('users.management.Email'),\n        width: 140\n      }, {\n        prop: 'roles',\n        name: gT('users.management.Roles'),\n        width: 120,\n        cellTemplate: this.rolesTemplate\n      }, {\n        prop: 'phoneNumber',\n        name: gT('users.management.PhoneNumber'),\n        width: 100\n      }];\n\n      if (this.canManageUsers) {\n        this.columns.push({\n          name: '',\n          width: 160,\n          cellTemplate: this.actionsTemplate,\n          resizeable: false,\n          canAutoResize: false,\n          sortable: false,\n          draggable: false\n        });\n      }\n\n      this.loadData();\n    }\n\n    ngAfterViewInit() {\n      this.userEditor.changesSavedCallback = () => {\n        this.addNewUserToList();\n        this.editorModal.hide();\n      };\n\n      this.userEditor.changesCancelledCallback = () => {\n        this.editedUser = null;\n        this.sourceUser = null;\n        this.editorModal.hide();\n      };\n    }\n\n    addNewUserToList() {\n      if (this.sourceUser) {\n        Object.assign(this.sourceUser, this.editedUser);\n        let sourceIndex = this.rowsCache.indexOf(this.sourceUser, 0);\n\n        if (sourceIndex > -1) {\n          Utilities.moveArrayItem(this.rowsCache, sourceIndex, 0);\n        }\n\n        sourceIndex = this.rows.indexOf(this.sourceUser, 0);\n\n        if (sourceIndex > -1) {\n          Utilities.moveArrayItem(this.rows, sourceIndex, 0);\n        }\n\n        this.editedUser = null;\n        this.sourceUser = null;\n      } else {\n        const user = new User();\n        Object.assign(user, this.editedUser);\n        this.editedUser = null;\n        let maxIndex = 0;\n\n        for (const u of this.rowsCache) {\n          if (u.index > maxIndex) {\n            maxIndex = u.index;\n          }\n        }\n\n        user.index = maxIndex + 1;\n        this.rowsCache.splice(0, 0, user);\n        this.rows.splice(0, 0, user);\n        this.rows = [...this.rows];\n      }\n    }\n\n    loadData() {\n      this.alertService.startLoadingMessage();\n      this.loadingIndicator = true;\n\n      if (this.canViewRoles) {\n        this.accountService.getUsersAndRoles().subscribe(results => this.onDataLoadSuccessful(results[0], results[1]), error => this.onDataLoadFailed(error));\n      } else {\n        this.accountService.getUsers().subscribe(users => this.onDataLoadSuccessful(users, this.accountService.currentUser.roles.map(x => new Role(x))), error => this.onDataLoadFailed(error));\n      }\n    }\n\n    onDataLoadSuccessful(users, roles) {\n      this.alertService.stopLoadingMessage();\n      this.loadingIndicator = false;\n      users.forEach((user, index) => {\n        user.index = index + 1;\n      });\n      this.rowsCache = [...users];\n      this.rows = users;\n      this.allRoles = roles;\n    }\n\n    onDataLoadFailed(error) {\n      this.alertService.stopLoadingMessage();\n      this.loadingIndicator = false;\n      this.alertService.showStickyMessage('Load Error', `Unable to retrieve users from the server.\\r\\nErrors: \"${Utilities.getHttpResponseMessages(error)}\"`, MessageSeverity.error, error);\n    }\n\n    onSearchChanged(value) {\n      this.rows = this.rowsCache.filter(r => Utilities.searchArray(value, false, r.userName, r.fullName, r.email, r.phoneNumber, r.jobTitle, r.roles));\n    }\n\n    onEditorModalHidden() {\n      this.editingUserName = null;\n      this.userEditor.resetForm(true);\n    }\n\n    newUser() {\n      this.editingUserName = null;\n      this.sourceUser = null;\n      this.editedUser = this.userEditor.newUser(this.allRoles);\n      this.editorModal.show();\n    }\n\n    editUser(row) {\n      this.editingUserName = {\n        name: row.userName\n      };\n      this.sourceUser = row;\n      this.editedUser = this.userEditor.editUser(row, this.allRoles);\n      this.editorModal.show();\n    }\n\n    deleteUser(row) {\n      this.alertService.showDialog('Are you sure you want to delete \\\"' + row.userName + '\\\"?', DialogType.confirm, () => this.deleteUserHelper(row));\n    }\n\n    deleteUserHelper(row) {\n      this.alertService.startLoadingMessage('Deleting...');\n      this.loadingIndicator = true;\n      this.accountService.deleteUser(row).subscribe(results => {\n        this.alertService.stopLoadingMessage();\n        this.loadingIndicator = false;\n        this.rowsCache = this.rowsCache.filter(item => item !== row);\n        this.rows = this.rows.filter(item => item !== row);\n      }, error => {\n        this.alertService.stopLoadingMessage();\n        this.loadingIndicator = false;\n        this.alertService.showStickyMessage('Delete Error', `An error occured whilst deleting the user.\\r\\nError: \"${Utilities.getHttpResponseMessages(error)}\"`, MessageSeverity.error, error);\n      });\n    }\n\n    get canAssignRoles() {\n      return this.accountService.userHasPermission(Permission.assignRolesPermission);\n    }\n\n    get canViewRoles() {\n      return this.accountService.userHasPermission(Permission.viewRolesPermission);\n    }\n\n    get canManageUsers() {\n      return this.accountService.userHasPermission(Permission.manageUsersPermission);\n    }\n\n  }\n\n  UsersManagementComponent.ɵfac = function UsersManagementComponent_Factory(t) {\n    return new (t || UsersManagementComponent)(i0.ɵɵdirectiveInject(i1.AlertService), i0.ɵɵdirectiveInject(i2.AppTranslationService), i0.ɵɵdirectiveInject(i3.AccountService));\n  };\n\n  UsersManagementComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: UsersManagementComponent,\n    selectors: [[\"app-users-management\"]],\n    viewQuery: function UsersManagementComponent_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(_c0, 7);\n        i0.ɵɵviewQuery(_c1, 7);\n        i0.ɵɵviewQuery(_c2, 7);\n        i0.ɵɵviewQuery(_c3, 7);\n        i0.ɵɵviewQuery(_c4, 7);\n        i0.ɵɵviewQuery(_c5, 7);\n      }\n\n      if (rf & 2) {\n        let _t;\n\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.indexTemplate = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.userNameTemplate = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.rolesTemplate = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.actionsTemplate = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.editorModal = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.userEditor = _t.first);\n      }\n    },\n    decls: 31,\n    vars: 17,\n    consts: [[1, \"row\", \"control-box\"], [1, \"col-lg-8\"], [1, \"form-group\", \"search-box\"], [3, \"placeholder\", \"searchChange\"], [1, \"col-lg-4\", \"pr-lg-5\"], [1, \"nav\", \"flex-column\", \"flex-lg-row\", \"justify-content-end\"], [\"class\", \"nav-item toolbaritem\", 4, \"ngIf\"], [1, \"material\", \"colored-header\", \"sm\", \"table\", \"table-striped\", \"table-hover\", 3, \"loadingIndicator\", \"rows\", \"rowHeight\", \"headerHeight\", \"footerHeight\", \"columns\", \"scrollbarV\", \"columnMode\"], [\"indexTemplate\", \"\"], [\"userNameTemplate\", \"\"], [\"rolesTemplate\", \"\"], [\"actionsTemplate\", \"\"], [\"bsModal\", \"\", \"tabindex\", \"-1\", 1, \"modal\", \"fade\", 3, \"config\", \"onHidden\"], [\"editorModal\", \"bs-modal\"], [1, \"modal-dialog\", \"modal-lg\"], [1, \"modal-content\"], [1, \"modal-header\"], [\"class\", \"modal-title float-left\", 4, \"ngIf\"], [\"type\", \"button\", \"title\", \"Close\", 1, \"close\", \"float-right\", 3, \"click\"], [\"aria-hidden\", \"true\"], [1, \"modal-body\"], [3, \"isGeneralEditor\"], [\"userEditor\", \"\"], [1, \"nav-item\", \"toolbaritem\"], [\"href\", \"javascript:;\", 1, \"nav-link\", 3, \"click\"], [1, \"fa\", \"fa-plus-circle\"], [\"class\", \"fa fa-exclamation-triangle\", 4, \"ngIf\"], [\"class\", \"fa fa-exclamation\", 4, \"ngIf\"], [1, \"fa\", \"fa-exclamation-triangle\"], [1, \"fa\", \"fa-exclamation\"], [\"class\", \"user-role badge badge-pill badge-secondary\", 4, \"ngFor\", \"ngForOf\"], [1, \"user-role\", \"badge\", \"badge-pill\", \"badge-secondary\"], [4, \"ngIf\"], [\"href\", \"javascript:;\", 1, \"btn\", \"btn-link\", \"btn-sm\", 3, \"click\"], [\"aria-hidden\", \"true\", 1, \"fa\", \"fa-pencil-square-o\"], [\"aria-hidden\", \"true\", 1, \"fa\", \"fa-trash-o\"], [1, \"modal-title\", \"float-left\"], [1, \"fa\", \"fa-user-plus\"], [1, \"fa\", \"fa-user-circle-o\"]],\n    template: function UsersManagementComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        const _r34 = i0.ɵɵgetCurrentView();\n\n        i0.ɵɵelementStart(0, \"div\")(1, \"div\", 0)(2, \"div\", 1)(3, \"div\", 2)(4, \"app-search-box\", 3);\n        i0.ɵɵlistener(\"searchChange\", function UsersManagementComponent_Template_app_search_box_searchChange_4_listener($event) {\n          return ctx.onSearchChanged($event);\n        });\n        i0.ɵɵpipe(5, \"translate\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(6, \"div\", 4)(7, \"ul\", 5);\n        i0.ɵɵtemplate(8, UsersManagementComponent_li_8_Template, 5, 3, \"li\", 6);\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelement(9, \"ngx-datatable\", 7);\n        i0.ɵɵtemplate(10, UsersManagementComponent_ng_template_10_Template, 2, 1, \"ng-template\", null, 8, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(12, UsersManagementComponent_ng_template_12_Template, 4, 7, \"ng-template\", null, 9, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(14, UsersManagementComponent_ng_template_14_Template, 1, 1, \"ng-template\", null, 10, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(16, UsersManagementComponent_ng_template_16_Template, 1, 1, \"ng-template\", null, 11, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵelementStart(18, \"div\", 12, 13);\n        i0.ɵɵlistener(\"onHidden\", function UsersManagementComponent_Template_div_onHidden_18_listener() {\n          return ctx.onEditorModalHidden();\n        });\n        i0.ɵɵelementStart(20, \"div\", 14)(21, \"div\", 15)(22, \"div\", 16);\n        i0.ɵɵtemplate(23, UsersManagementComponent_h4_23_Template, 4, 3, \"h4\", 17);\n        i0.ɵɵtemplate(24, UsersManagementComponent_h4_24_Template, 4, 4, \"h4\", 17);\n        i0.ɵɵelementStart(25, \"button\", 18);\n        i0.ɵɵlistener(\"click\", function UsersManagementComponent_Template_button_click_25_listener() {\n          i0.ɵɵrestoreView(_r34);\n\n          const _r9 = i0.ɵɵreference(19);\n\n          return _r9.hide();\n        });\n        i0.ɵɵelementStart(26, \"span\", 19);\n        i0.ɵɵtext(27, \"\\u00D7\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(28, \"div\", 20);\n        i0.ɵɵelement(29, \"app-user-info\", 21, 22);\n        i0.ɵɵelementEnd()()()()();\n      }\n\n      if (rf & 2) {\n        i0.ɵɵadvance(4);\n        i0.ɵɵpropertyInterpolate(\"placeholder\", i0.ɵɵpipeBind1(5, 14, \"users.management.Search\"));\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngIf\", ctx.canManageUsers && ctx.canAssignRoles);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"loadingIndicator\", ctx.loadingIndicator)(\"rows\", ctx.rows)(\"rowHeight\", 35)(\"headerHeight\", 35)(\"footerHeight\", 35)(\"columns\", ctx.columns)(\"scrollbarV\", true)(\"columnMode\", \"force\");\n        i0.ɵɵadvance(9);\n        i0.ɵɵproperty(\"config\", i0.ɵɵpureFunction0(16, _c6));\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"ngIf\", !ctx.editingUserName);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.editingUserName);\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"isGeneralEditor\", true);\n      }\n    },\n    styles: [\".user-role[_ngcontent-%COMP%]{font-size:.8em!important;margin-right:1px}.control-box[_ngcontent-%COMP%]{margin-bottom:5px}.search-box[_ngcontent-%COMP%]{margin:0}.nav-item.toolbaritem[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{padding-top:3px;padding-bottom:3px;min-width:100px}.user-disabled[_ngcontent-%COMP%]{color:#777;font-style:italic}.locked-out[_ngcontent-%COMP%]{background-color:#ff4500;color:#f5f5f5;width:100%;display:inline-block;padding-left:5px}\"]\n  });\n  return UsersManagementComponent;\n})();","map":null,"metadata":{},"sourceType":"module"}